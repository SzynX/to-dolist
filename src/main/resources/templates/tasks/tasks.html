<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ğŸ“‹ Task List</title>
    <link rel="stylesheet" href="/css/styles.css">
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ—‚ï¸ Task Overview</h1>
    </header>

    <main>
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <div class="action-buttons">
            <a href="/tasks/new" class="btn btn-create">â• Create New Task</a> <a href="/users" class="btn btn-manage">ğŸ‘¤ Manage Users</a> <a href="/tasks/due-warning" class="btn btn-warning">âš ï¸ Due Date Warnings</a> </div>

        <div class="task-list">
            <table class="styled-table" th:if="${tasks != null and not #lists.isEmpty(tasks)}">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>âœ…</th> <th>ğŸ“Œ Title</th>
                    <th>ğŸ‘¤ Assigned User</th>
                    <th>ğŸ“ˆ Status</th>
                    <th>ğŸ“… Due Date</th>
                    <th>âš¡ Priority</th>
                    <th>âš™ï¸ Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="task : ${tasks}"
                    th:class="'task-row status-' + ${task.status != null ? task.status.name() : 'UNKNOWN'} +
                              ' priority-' + ${task.priority != null ? task.priority.name() : 'UNKNOWN'} +
                              (${task.dueDate != null and task.dueDate.isBefore(T(java.time.LocalDate).now().plusDays(1)) and !task.completed ? ' due-warning' : ''}) + (${task.completed ? ' completed-task' : ''})" > <td th:text="${task.id}">1</td>
                    <td> <input
                            type="checkbox"
                            th:checked="${task.completed}"
                            th:data-task-id="${task.id}" class="task-completed-checkbox" />
                    </td>
                    <td th:text="${task.title}">Task Title</td>
                    <td th:text="${task.user != null ? task.user.name : 'Unassigned'}">N/A</td>
                    <td>
                        <span th:switch="${task.status != null ? task.status.name() : 'UNKNOWN'}">
                            <span th:case="'PENDING'">ğŸ“Œ Pending</span>
                            <span th:case="'IN_PROGRESS'">â³ In Progress</span>
                            <span th:case="'COMPLETED'">âœ… Completed</span>
                            <span th:case="'UNKNOWN'">â“ Unknown</span>
                        </span>
                    </td>
                    <td th:text="${task.dueDate != null ? #temporals.format(task.dueDate, 'yyyy-MM-dd') : 'N/A'}">2025-05-10</td> <td>
                        <span th:text="${task.priority != null ? task.priority.name() : 'UNKNOWN'}"
                              th:class="'priority-' + ${task.priority != null ? task.priority.name().toLowerCase() : 'unknown'}"> </span>
                    </td>
                    <td>
                        <a th:href="@{/tasks/edit/{id}(id=${task.id})}" class="btn-edit">âœï¸ Edit</a>
                        <form th:action="@{/tasks/delete/{id}(id=${task.id})}" method="post" style="display:inline;">
                            <input type="hidden" name="_method" value="DELETE"/> <button type="submit" class="btn-delete">ğŸ—‘ï¸ Delete</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>

            <div th:if="${tasks == null or #lists.isEmpty(tasks)}" class="no-tasks"> <p>ğŸ›‘ No tasks found. Create your first one!</p>
            </div>
        </div>
    </main>

    <script>
        // JavaScript a checkbox kattintÃ¡sok kezelÃ©sÃ©re
        document.addEventListener('DOMContentLoaded', function () {
            // MegkeressÃ¼k az Ã¶sszes checkboxot, aminek a 'task-completed-checkbox' osztÃ¡lya van
            const checkboxes = document.querySelectorAll('.task-completed-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const taskId = this.dataset.taskId; // LekÃ©rjÃ¼k a feladat ID-t az adatattribÃºtumbÃ³l
                    const isCompleted = this.checked; // LekÃ©rjÃ¼k a checkbox Ãºj Ã¡llapotÃ¡t
                    const row = this.closest('.task-row'); // MegkeressÃ¼k a legkÃ¶zelebbi sor elemet

                    // AJAX kÃ©rÃ©s kÃ¼ldÃ©se a szervernek
                    fetch(`/tasks/toggle-completed/${taskId}`, {
                        method: 'POST', // POST kÃ©rÃ©s az endpointra
                        headers: {
                            'Content-Type': 'application/json',
                            // SzÃ¼ksÃ©g lehet CSRF tokenre Spring Security esetÃ©n
                            // Pl: 'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                        },
                        // Body: opcionÃ¡lisan elkÃ¼ldhetjÃ¼k az Ãºj stÃ¡tuszt is, de a szerver oldalon egyszerÅ±bb csak vÃ¡ltani
                        // body: JSON.stringify({ completed: isCompleted })
                    })
                        .then(response => {
                            if (!response.ok) {
                                // Hiba esetÃ©n visszagÃ¶rgetjÃ¼k a checkbox Ã¡llapotÃ¡t
                                this.checked = !isCompleted;
                                // HibaÃ¼zenet megjelenÃ­tÃ©se (opcionÃ¡lis)
                                console.error('Failed to toggle task completed status');
                                alert('Failed to update task status.');
                            } else {
                                // Sikeres frissÃ­tÃ©s esetÃ©n vizuÃ¡lisan frissÃ­tjÃ¼k a sort
                                if (isCompleted) {
                                    row.classList.add('completed-task');
                                    // OpcionÃ¡lisan frissÃ­theted a stÃ¡tusz cellÃ¡t is "âœ… Completed"-re
                                    const statusCell = row.querySelector('td:nth-child(5)'); // Figyelj az oszlop szÃ¡mÃ¡ra
                                    if (statusCell) {
                                        statusCell.innerHTML = '<span class="status-COMPLETED">âœ… Completed</span>';
                                    }
                                } else {
                                    row.classList.remove('completed-task');
                                    // OpcionÃ¡lisan frissÃ­theted a stÃ¡tusz cellÃ¡t is "ğŸ“Œ Pending"-re (vagy az eredetire)
                                    const statusCell = row.querySelector('td:nth-child(5)'); // Figyelj az oszlop szÃ¡mÃ¡ra
                                    if (statusCell) {
                                        // Ez bonyolultabb lehet, ha vissza kell Ã¡llÃ­tani az eredeti stÃ¡tuszt
                                        // EgyszerÅ±bb, ha csak a completed stÃ¡tuszra reagÃ¡l a CSS
                                    }
                                }
                                // TÃ¡volÃ­tsuk el a lejÃ¡rat figyelmeztetÃ©s stÃ­lust, ha kÃ©szen van
                                if (isCompleted) {
                                    row.classList.remove('due-warning');
                                } else {
                                    // Ha visszavonjuk a kÃ©szenlÃ©tet, ellenÅ‘rizzÃ¼k Ãºjra a hatÃ¡ridÅ‘ figyelmeztetÃ©st
                                    // Ez a legegyszerÅ±bben egy oldalfrissÃ­tÃ©ssel vagy egy kÃ¼lÃ¶n JS fÃ¼ggvÃ©nnyel tÃ¶rtÃ©nhet
                                    // Most az egyszerÅ±sÃ©g kedvÃ©Ã©rt nem csinÃ¡lunk itt semmit, a kÃ¶vetkezÅ‘ betÃ¶ltÃ©skor jÃ³ lesz
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            // Hiba esetÃ©n visszagÃ¶rgetjÃ¼k a checkbox Ã¡llapotÃ¡t
                            this.checked = !isCompleted;
                            alert('An error occurred while updating task status.');
                        });
                });
            });
        });
    </script>

</div>
</body>
</html>